---
title: "R Notebook"
output: html_notebook
---

```{r setup}
library(data.table)
library(stringr)

library(tictoc)
library(profvis)

raw <- file("./materiel/challenge.bin", "rb")
cmdlist <- readBin(raw, integer(), n = 32678, size = 2, 
                   endian = "little", signed = FALSE)
rm(raw)

bin_const <- 2^(0:14)
```

```{r}
stack <- c()
printqueue <- c()

registers <- data.table(z = 0:7,
                        val = c(rep(as.numeric(NA), 8)),
                        mod = 0:7+32768)
setkey(registers, mod)
setorder(registers, z)

memory <- data.table(z = 0:32767,
                     cmd = c(cmdlist, 
                             rep(0, (32768 - length(cmdlist)))),
                     do = c(rep(as.logical(NA), 32768)),
                     done = c(rep(as.logical(NA), 32768))
                     )
setkey(memory, z)
```
```{r}
finish <- \(loc, args = 0) { #expect z-indexed
  memory[((loc) + 1):((loc) + 1 + (args)), done := TRUE]
  doing <<- (loc + args)
  return(invisible(NULL))
}

start <- \(loc) { #expect z-indexed
  memory[((loc) + 1), do := TRUE]
  work <- memory[((loc) + 1):((loc) + 5), cmd]
  stopifnot(work[1] <= 21)
  work
}

read_register <- \(x) { #accepts reg z-index or reserved number
  if (x >= 32768) { val <- registers[mod == x, val]
  } else { val <- registers[z == x, val] }
  return(invisible(NULL))
}

read_loc <- \(x) { #equivalent to do_place()
  if (x >= 32768) { val <- read_register(x)
  } else { val <- memory[z == (x), cmd] }
  return(invisible(NULL))
}

use_integer <- \(x) { #equivalent to do_read()
  if (x >= 32768) { val <- read_register(x)
  } else { val <- x }
  return(invisible(NULL))
}

write_loc <- \(value, to) {
  if (to >= 32768) {
    registers[mod == (to), val := (value)]
  } else {
    memory[z == (to), val := (value)]
  }
  return(invisible(NULL))
}

pop_stack <- \() {
  stopifnot(length(stack) > 0) 
  x <- stack[1]
  stack <<- stack[-1]
  x
}
```
```{r}
dispatcheR <- \() {
  work <- start(doing)
  perform <- work[1]
  use <- work[-1]
  if (perform != 19 & length(printqueue) > 0) {
    print(paste0("PRINT QUEUE: \n", printqueue, "\n END PRINT QUEUE"))
    printqueue <<- c()
  }
  if (perform == 0) { op_00_halt() }
  if (perform == 1) { op_01_set(use) }
  if (perform == 2) { op_02_push(use) }
  
  return(invisible(NULL))
}
```

```{r}
op_00_halt <- \() {
  print(paste0("Program halted by z-index ", doing))
  finish(doing)
  doing <<- 32768
  return(invisible(NULL))
}

op_01_set <- \(work) {
  a <- work[1]
  finish(doing, 1)
  return(invisible(NULL))
}

op_02_push <- \(work) {
  a <- work[1]
  finish(doing, 1)
  return(invisible(NULL))
}

op_03_pop <- \(work) {
  a <- work[1]
  val <- pop_stack()
  write_loc(value = val, to = a)
  finish(doing, 1)
  return(invisible(NULL))
}

op_04_eq <- \(work) {
  a <- work[1]
  b <- use_integer(work[2])
  c <- use_integer(work[3])
  if (identical(b, c)) {
    write_loc(value = 1, to = a)
  } else {
    write_loc(value = 0, to = a)
  }
  finish(doing, 3)
  return(invisible(NULL))
}

op_05_gt <- \(work) {
  a <- work[1]
  b <- use_integer(work[2])
  c <- use_integer(work[3])
  if (isTRUE(b > c)) {
    write_loc(value = 1, to = a)
  } else {
    write_loc(value = 0, to = a)
  }
  finish(doing, 3)
  return(invisible(NULL))
}

op_06_jmp <- \(work) {
  a <- use_integer(work[1])
  finish(doing, 1)
  doing <<- a 
  return(invisible(NULL))
}

op_07_jt <- \(work) {
  a <- use_integer(work[1])
  b <- use_integer(work[2])
  finish(doing, 2)
  if (isTRUE(a > 0)) {
    doing <<- b
  }
  return(invisible(NULL))
}

op_08_jf <- \(work) {
  a <- use_integer(work[1])
  b <- use_integer(work[2])
  finish(doing, 2)
  if (a == 0) {
    doing <<- b
  }
} 

op_09_add <- \(work) {
  a <- work[1]
  b <- use_integer(work[2])
  c <- use_integer(work[3])
  got <- (b + c) %% 32768
  write_loc(value = got, to = a)
  finish(doing, 3)
  return(invisible(NULL))
}

op_10_mult <- \(work) {
  a <- work[1]
  b <- use_integer(work[2])
  c <- use_integer(work[3])
  got <- (b * c) %% 32768
  write_loc(value = got, to = a)
  finish(doing, 3)
  return(invisible(NULL))
}

op_11_mod <- \(work) {
  a <- work[1]
  b <- use_integer(work[2])
  c <- use_integer(work[3])
  got <- b %% c
  write_loc(value = got, to = a)
  finish(doing, 3)
  return(invisible(NULL))
}

op_12_and <- \(work) {
  a <- work[1]
  b <- use_integer(work[2])
  c <- use_integer(work[3])
  bits <- bitwAnd(b, c)
  write_loc(bits, a)
  finish(doing, 3)
  return(invisible(NULL))
}

op_13_or <- \(work) {
  a <- work[1]
  b <- use_integer(work[2])
  c <- use_integer(work[3])
  bits <- bitwOr(b, c)
  write_loc(bits, a)
  finish(doing, 3)
  return(invisible(NULL))
}

op_14_not <- \(work) {
  a <- work[1]
  b <- use_integer(work[2])
  bb <- as.integer(intToBits(b))[1:15]
  bt <- bb == 0
  bits <- sum(bin_const[bt])
  write_loc(bits, a)
  finish(doing, 2)
  return(invisible(NULL))
}

op_15_rmem <- \(work) {
  a <- work[1]
  b <- read_register(work[2]) |> read_loc()
  write_loc(value = b, to = a)
  finish(doing, 2)
  return(invisible(NULL))
}

op_16_wmem <- \(work) {
  a <- use_integer(work[1])
  b <- use_integer(work[2])
  write_loc(value = b, to = a)
  finish(doing, 2)
  return(invisible(NULL))
}

op_17_call <- \(work) {
  a <- use_integer(work[1])
  finish(doing, 1) #update doing to find stack value
  stack <<- c(doing, stack) #push to stack
  doing <<- a #update doing again to find real destination
  return(invisible(NULL))
}

op_18_ret <- \() {
  if (isTRUE(length(stack) < 1)) {
    finish(doing, 0)
    op_00_halt()
  } else {
    finish(doing, 0)
    place <- use_integer(pop_stack())
    doing <<- place 
  }
  return(invisible(NULL))
}

op_19_out <- \(work) {
  a <- use_integer(work[1])
  ch <- rawToChar(as.raw(a))
  printqueue <<- c(printqueue, ch)
  finish(doing, 1)
  return(invisible(NULL))
}

op_20_in <- \(work) {
  a <- use_integer(work[1])
  str <- readline() |> strsplit()
  for (i in seq_len(length(str))) {
    go <- a + (i - 1)
    ch <- charToRaw(str[[i]])
    write_loc(value = ch, to = go)
  }
  finish(doing, 1)
  return(invisible(NULL))
}

op_21_noop <- \() {
  print("...")
  finish(doing, 0)
  return(invisible(NULL))
}

```

